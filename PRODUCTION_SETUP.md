# QuickBooks MCP Server - Production Setup for Copilot Studio

## ğŸ‰ What We Built

A **production-ready HTTP MCP server** that integrates with Microsoft Copilot Studio's OAuth 2.0 system, enabling **multi-user QuickBooks access** without needing mcp-proxy.

### Key Features

âœ… **Native HTTP Server** - No mcp-proxy dependency
âœ… **Multi-User Support** - Each Teams user has their own QuickBooks tokens
âœ… **Copilot Studio OAuth** - Handles authentication automatically
âœ… **Backward Compatible** - Still works with .env tokens for local testing
âœ… **Production Ready** - Express-based, scalable, enterprise-grade

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Microsoft Teams â”‚
â”‚ User A, User B  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Copilot Studio                                   â”‚
â”‚ - Manages OAuth per user                         â”‚
â”‚ - Stores tokens securely                         â”‚
â”‚ - Passes tokens in Authorization header          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTPS
         â”‚ Authorization: Bearer <user_token>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QuickBooks MCP Server (HTTP Mode)               â”‚
â”‚ Port: 8080                                        â”‚
â”‚ - Extracts tokens from headers                   â”‚
â”‚ - Uses tokens for QuickBooks API                 â”‚
â”‚ - Returns data to Copilot Studio                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ OAuth 2.0
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QuickBooks Online API                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Quick Start

### 1. Start the Production Server

```bash
# Build (if not already done)
npm run build

# Start production HTTP server
npm run start:http
```

You should see:
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   QuickBooks Online MCP Server (Production HTTP Mode)         â•‘
â•‘   Port: 8080                                                   â•‘
â•‘   Auth Mode: external                                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ Registered 3 QuickBooks tools

ğŸš€ Server running on http://localhost:8080
ğŸ“¡ MCP endpoint: http://localhost:8080/mcp
ğŸ’“ Health check: http://localhost:8080/health

ğŸ’¡ Ready for Copilot Studio connections!
```

### 2. Set Up Tunnel (for Testing)

```bash
# Option A: ngrok
ngrok http 8080

# Option B: cloudflared
cloudflared tunnel --url http://localhost:8080

# Copy the HTTPS URL (e.g., https://abc123.ngrok.io)
```

### 3. Configure Copilot Studio OAuth

In Copilot Studio, add MCP connection with these settings:

#### Connection Settings
- **Name**: QuickBooks Online
- **MCP Endpoint**: `https://your-tunnel-url.ngrok.io/mcp`
- **Transport**: Streamable HTTP

#### OAuth 2.0 Configuration
Select **OAuth 2.0 â†’ Manual**:

```
Type: Manual

Client ID: (from your .env - QUICKBOOKS_CLIENT_ID)
Client Secret: (from your .env - QUICKBOOKS_CLIENT_SECRET)

Authorization URL (Sandbox):
https://appcenter-sandbox.intuit.com/connect/oauth2

Authorization URL (Production):
https://appcenter.intuit.com/connect/oauth2

Token URL:
https://oauth.platform.intuit.com/oauth2/v1/tokens/bearer

Refresh URL:
https://oauth.platform.intuit.com/oauth2/v1/tokens/bearer

Scopes:
com.intuit.quickbooks.accounting

Redirect URL:
(Auto-generated by Copilot Studio - copy this to Intuit Developer Portal)
```

### 4. Update Intuit Developer Portal

1. Go to https://developer.intuit.com/
2. Navigate to your app â†’ **Keys & OAuth**
3. Add the **Redirect URL** from Copilot Studio to your allowed redirect URIs
4. Save

### 5. Test the Integration

In Microsoft Teams, ask your Copilot:

```
"Show me QuickBooks customers"
```

**First Time:**
- Copilot will prompt: "Let's get you connected first. Open connection manager"
- Click to authorize
- Sign in to QuickBooks
- Authorize the app
- âœ… Done! Future requests work automatically

**Subsequent Times:**
- No authorization needed
- Instant responses
- Each user has their own connection

---

## How Authentication Works

### First Request from User A

```
1. User A: "Show me customers"
2. Copilot Studio: "No tokens for User A, starting OAuth..."
3. Browser opens â†’ User A signs into QuickBooks
4. Copilot Studio: Saves tokens for User A
5. Request to MCP server with User A's token:
   Authorization: Bearer <user_a_token>
6. MCP Server: Extracts token, calls QuickBooks API
7. Returns: User A's customers
```

### Subsequent Requests from User A

```
1. User A: "Create a customer"
2. Copilot Studio: Uses stored tokens for User A
3. Request to MCP server with User A's token
4. MCP Server: Uses token, creates customer
5. Returns: Success
```

### Request from User B (Different User)

```
1. User B: "Show me customers"
2. Copilot Studio: "No tokens for User B, starting OAuth..."
3. Browser opens â†’ User B signs into QuickBooks
4. Copilot Studio: Saves tokens for User B (separate from User A)
5. Returns: User B's customers (from their QuickBooks company)
```

---

## Realm ID Handling

The QuickBooks **Realm ID** (company ID) is needed for API calls but may not be passed by Copilot Studio.

### Solution: Fallback to .env

The server uses this priority:

1. **Realm ID from request** (if Copilot Studio provides it)
2. **Realm ID from storage** (user-realm mappings in `data/user-realms.json`)
3. **Fallback to .env** (`QUICKBOOKS_REALM_ID`)

For now, ensure `QUICKBOOKS_REALM_ID` is set in `.env`:

```env
QUICKBOOKS_REALM_ID=9341455743710712
```

This works for single-company scenarios. For multi-company:
- Each user gets their own realm ID stored in `data/user-realms.json`
- Automatically populated on first successful auth

---

## Available Tools

Currently enabled (3 tools for testing):

1. **`search_customers`** - Search QuickBooks customers
2. **`create_customer`** - Create a new customer
3. **get_customer`** - Get customer by ID

### Enable More Tools

Edit `src/index-http.ts` and add more tools:

```typescript
// Add these imports
import { SearchInvoicesTool } from "./tools/search-invoices.tool.js";
import { CreateInvoiceTool } from "./tools/create-invoice.tool.js";
// ... etc

// Add to tools array
const tools = [
  SearchCustomersTool,
  CreateCustomerTool,
  GetCustomerTool,
  SearchInvoicesTool,  // Add
  CreateInvoiceTool,   // Add
  // ... add more as needed
];
```

Then rebuild:
```bash
npm run build
```

---

## Environment Variables

### Required (.env)

```env
# QuickBooks OAuth Credentials
QUICKBOOKS_CLIENT_ID=your_client_id
QUICKBOOKS_CLIENT_SECRET=your_client_secret
QUICKBOOKS_ENVIRONMENT=sandbox

# Fallback Realm ID (required for now)
QUICKBOOKS_REALM_ID=your_company_id
```

### Optional

```env
# Server Configuration
PORT=8080
AUTH_MODE=external
TRANSPORT=http

# Realm ID Storage
REALM_ID_STORAGE_PATH=./data/user-realms.json
```

---

## Deployment to Production

### Option 1: Azure App Service

```bash
# Deploy to Azure
az webapp create --resource-group myResourceGroup \
  --plan myAppServicePlan \
  --name quickbooks-mcp-server \
  --runtime "NODE|18-lts"

# Configure env vars in Azure Portal
# Set QUICKBOOKS_CLIENT_ID, QUICKBOOKS_CLIENT_SECRET, etc.

# Deploy
az webapp deployment source config-zip \
  --resource-group myResourceGroup \
  --name quickbooks-mcp-server \
  --src dist.zip
```

### Option 2: Docker

```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --production
COPY dist ./dist
EXPOSE 8080
CMD ["node", "dist/index-http.js"]
```

```bash
docker build -t quickbooks-mcp .
docker run -p 8080:8080 --env-file .env quickbooks-mcp
```

### Option 3: Cloud Run / Lambda

Use the Express server as-is. Both support Express apps natively.

---

## Troubleshooting

### âš ï¸ "Access token provided but realm ID missing"

**Cause**: Copilot Studio sent OAuth token but no realm ID

**Solution**: Ensure `QUICKBOOKS_REALM_ID` is set in `.env`

### âŒ "Tool not found: search_customers"

**Cause**: Tool not registered in HTTP server

**Solution**: Verify tool is in the `tools` array in `src/index-http.ts`

### âŒ "Invalid client credentials"

**Cause**: Wrong Client ID/Secret in Copilot Studio OAuth config

**Solution**: Double-check values match your `.env` and Intuit Developer Portal

### âŒ "Redirect URI mismatch"

**Cause**: Copilot Studio's redirect URL not added to Intuit Developer Portal

**Solution**: Copy redirect URL from Copilot Studio â†’ Add to Intuit portal â†’ Save

---

## Testing Locally (Without Copilot Studio)

You can test with .env tokens:

```bash
# Ensure .env has:
QUICKBOOKS_REFRESH_TOKEN=your_refresh_token
QUICKBOOKS_REALM_ID=your_realm_id

# Start server
npm run start:http

# Test with curl
curl -X POST http://localhost:8080/mcp \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "tools/list",
    "id": 1
  }'

# Should return list of 3 tools
```

---

## Comparing Production vs Development

| Feature | Development (stdio + mcp-proxy) | Production (HTTP) |
|---------|--------------------------------|-------------------|
| Command | `mcp-proxy --port 8080 node dist/index.js` | `npm run start:http` |
| Transport | stdio â†’ HTTP (via proxy) | Native HTTP |
| Auth | .env tokens only | Copilot Studio OAuth OR .env |
| Multi-user | âŒ No | âœ… Yes |
| Dependencies | Requires mcp-proxy | No external dependencies |
| Use Case | Local testing, Claude Desktop | Production, Teams, Enterprise |

---

## Next Steps

1. âœ… Server is running on port 8080
2. ğŸ”„ Set up ngrok tunnel
3. ğŸ”„ Configure OAuth in Copilot Studio (see section 3 above)
4. ğŸ”„ Add Copilot Studio redirect URL to Intuit Developer Portal
5. ğŸ”„ Test in Microsoft Teams
6. ğŸš€ Deploy to production when ready

---

## Support

- **QuickBooks API**: https://developer.intuit.com/app/developer/qbo/docs/
- **Copilot Studio**: https://learn.microsoft.com/en-us/microsoft-copilot-studio/
- **MCP Protocol**: https://modelcontextprotocol.io/

---

**Built with â¤ï¸ for Enterprise QuickBooks + Microsoft Teams Integration**
